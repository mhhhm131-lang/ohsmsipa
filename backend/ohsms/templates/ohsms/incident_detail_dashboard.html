{% load static %}
<!DOCTYPE html>
<html lang="ar" dir="rtl">
<head>
    <meta charset="UTF-8">
    <title>ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº</title>
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <link rel="stylesheet" href="{% static 'assets/css/styles.css' %}">
</head>
<body>

{% include "ohsms/partials/header.html" %}

<div class="main-wrapper">

  {% include "ohsms/partials/sidebar.html" %}

  <main class="content">

    <section class="card">
      <h2>ğŸ“„ ØªÙØ§ØµÙŠÙ„ Ø§Ù„Ø¨Ù„Ø§Øº</h2>

      <ul>
        <li><strong>Ø§Ù„Ø¹Ù†ÙˆØ§Ù†:</strong> {{ incident.title }}</li>
        <li><strong>Ø§Ù„Ù†ÙˆØ¹:</strong> {{ incident.get_incident_type_display }}</li>
        <li><strong>Ø§Ù„Ø­Ø§Ù„Ø©:</strong> {{ incident.get_status_display }}</li>
        <li><strong>Ø§Ù„ÙØ±Ø¹:</strong> {{ incident.branch }}</li>
        <li><strong>Ø§Ù„Ø¥Ø¯Ø§Ø±Ø©:</strong> {{ incident.department }}</li>
        <li><strong>Ø§Ù„Ù‚Ø³Ù…:</strong> {{ incident.section }}</li>
        <li><strong>ØªØ§Ø±ÙŠØ® Ø§Ù„Ø¥Ù†Ø´Ø§Ø¡:</strong> {{ incident.created_at }}</li>
      </ul>
    </section>

    <section class="card">
      <h3>âš™ï¸ Ø¥Ø¬Ø±Ø§Ø¡Ø§Øª Ø§Ù„Ø¨Ù„Ø§Øº</h3>

      <!-- Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Øº -->
      <form method="post" action="{% url 'incident_receive' incident.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary">ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¨Ù„Ø§Øº</button>
      </form>

      <br>
            {% if incident.status == "assigned" and incident.assigned_to == user %}
      <form method="post" action="{% url 'incident_accept_assignment' incident.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-warning">
          ğŸ“¥ Ø§Ø³ØªÙ„Ø§Ù… Ø§Ù„Ø¥Ø­Ø§Ù„Ø©
        </button>
      </form>

      <br>
      {% endif %}


      <!-- Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø© -->
      <form method="post" action="{% url 'incident_start_progress' incident.id %}">
        {% csrf_token %}
        <button type="submit" class="btn btn-secondary">â–¶ï¸ Ø¨Ø¯Ø¡ Ø§Ù„Ù…Ø¹Ø§Ù„Ø¬Ø©</button>
      </form>
    </section>

    <section class="card">
      <h4>â• Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</h4>
      <form method="post" action="{% url 'incident_add_note' incident.id %}">
        {% csrf_token %}
        <textarea name="note" rows="3" required class="textarea"></textarea><br><br>
        <button type="submit" class="btn btn-primary">Ø¥Ø¶Ø§ÙØ© Ù…Ù„Ø§Ø­Ø¸Ø©</button>
      </form>
    </section>

    <section class="card">
      <h4>ğŸ“¤ Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº</h4>
      <form method="post" action="{% url 'assign_incident' incident.id %}">
        {% csrf_token %}

        <label>Ø¥Ø­Ø§Ù„Ø© Ø¥Ù„Ù‰:</label><br>
        <select name="assignee" required class="input">
          <option value="">-- Ø§Ø®ØªØ± Ù…Ø³ØªØ®Ø¯Ù… --</option>
          {% for user in users %}
            <option value="{{ user.id }}">{{ user.username }}</option>
          {% endfor %}
        </select>

        <br><br>

        <label>Ù…Ù„Ø§Ø­Ø¸Ø© (Ø§Ø®ØªÙŠØ§Ø±ÙŠ):</label><br>
        <textarea name="note" rows="3" class="textarea"></textarea>

        <br><br>
        <button type="submit" class="btn btn-primary">Ø¥Ø­Ø§Ù„Ø© Ø§Ù„Ø¨Ù„Ø§Øº</button>
      </form>
    </section>

    <section class="card">
      <h4>ğŸ”— Ø±Ø¨Ø· Ø§Ù„Ø¨Ù„Ø§Øº Ø¨Ø³Ø¬Ù„ Ø§Ù„Ù…Ø®Ø§Ø·Ø±</h4>

      <form method="post" action="{% url 'incident_link_risk' incident.id %}">
        {% csrf_token %}

        <label>Ø§Ù„Ø®Ø·Ø± Ù…Ù† Ø§Ù„Ø³Ø¬Ù„ Ø§Ù„Ø¹Ø§Ù…:</label><br>
        <select name="risk_id" class="input">
          <option value="">-- Ø§Ø®ØªØ± Ø®Ø·Ø± --</option>
          {% for risk in risks %}
            <option value="{{ risk.id }}"
              {% if incident.risk and incident.risk.id == risk.id %}selected{% endif %}>
              {{ risk.title }}
            </option>
          {% endfor %}
        </select>

        <br><br>
        <button type="submit" class="btn btn-secondary">Ø±Ø¨Ø· Ø¨Ø§Ù„Ø®Ø·Ø±</button>
      </form>

      {% if incident.risk %}
        <p><strong>Ø§Ù„Ø®Ø·Ø± Ø§Ù„Ù…Ø±ØªØ¨Ø· Ø­Ø§Ù„ÙŠÙ‹Ø§:</strong> {{ incident.risk.title }}</p>
      {% endif %}
    </section>

    <section class="card">
      <h4>ğŸ”’ Ø§Ù„Ù‚Ø±Ø§Ø± Ø§Ù„Ø¥Ø¯Ø§Ø±ÙŠ</h4>

      <form method="post" action="{% url 'incident_close' incident.id %}" style="margin-bottom:10px;">
        {% csrf_token %}
        <textarea name="note" rows="2" class="textarea" placeholder="Ù…Ù„Ø§Ø­Ø¸Ø© Ø§Ù„Ø¥ØºÙ„Ø§Ù‚ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea><br><br>
        <button type="submit" class="btn btn-danger">Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº</button>
      </form>

      <form method="post" action="{% url 'incident_escalate' incident.id %}">
        {% csrf_token %}
        <textarea name="note" rows="2" class="textarea" placeholder="Ø³Ø¨Ø¨ Ø§Ù„ØªØµØ¹ÙŠØ¯ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea><br><br>
        <button type="submit" class="btn btn-warning">ØªØµØ¹ÙŠØ¯ Ø§Ù„Ø¨Ù„Ø§Øº</button>
      </form>
    </section>

    <section class="card">
      <h3>ğŸ•“ Ø³Ø¬Ù„ Ø§Ù„Ù…ØªØ§Ø¨Ø¹Ø©</h3>
      <ul>
        {% for event in events %}
          <li>
            <strong>{{ event.created_at }}</strong> |
            {{ event.get_action_display }} |
            Ø¨ÙˆØ§Ø³Ø·Ø©: {{ event.actor }}
            {% if event.note %}
              <br>Ù…Ù„Ø§Ø­Ø¸Ø©: {{ event.note }}
            {% endif %}
          </li>
        {% empty %}
          <li>Ù„Ø§ ØªÙˆØ¬Ø¯ Ø£Ø­Ø¯Ø§Ø« Ù…Ø³Ø¬Ù„Ø©</li>
        {% endfor %}
      </ul>
    </section>

    <a href="{% url 'incidents_dashboard' %}">â¬… Ø§Ù„Ø¹ÙˆØ¯Ø© Ø¥Ù„Ù‰ Ø§Ù„Ù‚Ø§Ø¦Ù…Ø©</a>

  </main>
</div>
{% if incident.status == "pending_reporter_confirmation" and user == incident.reporter %}
<section class="card">
  <h4>ØªØ£ÙƒÙŠØ¯ Ø¥ØºÙ„Ø§Ù‚ Ø§Ù„Ø¨Ù„Ø§Øº</h4>

  <form method="post" action="{% url 'incident_approve_close' incident.id %}">
    {% csrf_token %}
    <button type="submit">âœ… Ø£ÙˆØ§ÙÙ‚ Ø¹Ù„Ù‰ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</button>
  </form>

  <br>

  <form method="post" action="{% url 'incident_reject_close' incident.id %}">
    {% csrf_token %}
    <textarea name="note" placeholder="Ø³Ø¨Ø¨ Ø§Ù„Ø±ÙØ¶ (Ø§Ø®ØªÙŠØ§Ø±ÙŠ)"></textarea><br>
    <button type="submit">âŒ Ø£Ø±ÙØ¶ Ø§Ù„Ø¥ØºÙ„Ø§Ù‚</button>
  </form>
</section>
{% endif %}


</body>
</html>
